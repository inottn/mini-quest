<p align="center">
  <img alt="logo" src="https://fastly.jsdelivr.net/npm/@inottn/assets/miniapp-request/logo.svg" width="420" style="margin-bottom: 10px;">
</p>

<p align="center">ğŸš§ æ–½å·¥ä¸­ï¼Œaxios API é£æ ¼çš„å°ç¨‹åºè¯·æ±‚åº“</p>

## ç‰¹æ€§

- ä½¿ç”¨ TypeScript ç¼–å†™ï¼Œæä¾›å®Œæ•´çš„ç±»å‹å®šä¹‰
- æ”¯æŒ åˆ›å»ºå¤šä¸ªå®ä¾‹
- æ”¯æŒ [æ ¡éªŒçŠ¶æ€ç ](#æ ¡éªŒçŠ¶æ€ç )
- æ”¯æŒ [è¯·æ±‚ï¼å“åº”æ‹¦æˆªå™¨](#æ‹¦æˆªå™¨)
- æ”¯æŒ [è½¬æ¢è¯·æ±‚å’Œå“åº”æ•°æ®](#è½¬æ¢å™¨)
- æ”¯æŒ [è¯·æ±‚é”](#è¯·æ±‚é”)
- æ”¯æŒ ä¸Šä¼ ï¼ä¸‹è½½
- æ”¯æŒ è‡ªå®šä¹‰é€‚é…å™¨
- é€‚é… å¤šç«¯å°ç¨‹åºï¼ˆå¾®ä¿¡ã€æ”¯ä»˜å®ã€ç™¾åº¦ã€æŠ–éŸ³ç­‰ï¼‰

## å®‰è£…

ä½¿ç”¨ `pnpm` å®‰è£…:

```bash
pnpm add @inottn/miniapp-request
```

ä½¿ç”¨ `yarn` æˆ– `npm` å®‰è£…:

```bash
# ä½¿ç”¨ yarn
yarn add @inottn/miniapp-request

# ä½¿ç”¨ npm
npm i @inottn/miniapp-request
```

## åŸºæœ¬ç”¨ä¾‹

é»˜è®¤å¯¼å‡ºä¸€ä¸ªå®ä¾‹

```js
import instance from '@inottn/miniapp-request';

// å› ä¸ºæ˜¯é»˜è®¤å¯¼å‡ºï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä»»ä½•ä½ ä¹ æƒ¯çš„å‘½åï¼Œä¾‹å¦‚ï¼š
import axios from '@inottn/miniapp-request';
import http from '@inottn/miniapp-request';
```

å¦‚æœæœ‰éœ€è¦ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–°å»ºä¸€ä¸ªå®ä¾‹ã€‚

```js
import { create } from '@inottn/miniapp-request';

const instance = create({
  baseURL: 'https://base.domain.com',
  headers: { 'X-Custom-Header': 'foobar' },
});
```

å‘é€ GET è¯·æ±‚ï¼Œ`instance` æ˜¯ `instance.request` çš„ä¸€ä¸ªåˆ«å

```js
instance({ url: '/user?id=1' });

instance('/user?id=1');

instance.request('/user?id=1');

instance.get('/user?id=1');

instance.get('/user', {
  data: { id: '1' },
});
```

å‘é€ POST è¯·æ±‚

```js
instance({
  url: '/user/create',
  methods: 'post',
  data: {
    name: 'xxx',
  },
});

instance('/user/create', {
  methods: 'post',
  data: {
    name: 'xxx',
  },
});

instance.post({
  url: '/user/create',
  data: {
    name: 'xxx',
  },
});
```

å¹¶å‘è¯·æ±‚

```js
Promise.all([instance.get('/user?id=1'), instance.get('/user?id=2')]).then(
  ([user1, user2]) => {
    // ...
  },
);
```

## å®ä¾‹æ–¹æ³•

ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œä¸ºå¸¸ç”¨ä¸”æ”¯æŒçš„è¯·æ±‚æ–¹æ³•æä¾›äº†åˆ«åã€‚ä¸åŒå°ç¨‹åºå¹³å°æ”¯æŒçš„è¯·æ±‚æ–¹æ³•ä¼šæœ‰æ‰€ä¸åŒï¼Œä»¥å®é™…æƒ…å†µä¸ºå‡†ã€‚

#### instance(config)

#### instance.request(config)

#### instance.request(url[, config])

#### instance.delete(url[, config])

#### instance.download(url[, config])

#### instance.get(url[, config])

#### instance.head(url[, config])

#### instance.options(url[, config])

#### instance.post(url[, config])

#### instance.put(url[, config])

#### instance.upload(url[, config])

æ³¨æ„è¿™å’Œ axios æä¾›çš„å®ä¾‹æ–¹æ³•ç•¥æœ‰ä¸åŒï¼Œå¦‚æœä½ æ›´ä¹ æƒ¯ axios æä¾›çš„ä¼ å‚æ–¹å¼ï¼Œä½ ä¹Ÿå¯ä»¥åŸºäºæ­¤å†å°è£…ä¸€å±‚ã€‚

```js
export function post(url, data, config) {
  return instance.post(url, {
    ...config,
    data,
  });
}
```

## è¯·æ±‚é…ç½®

è¿™äº›æ˜¯åˆ›å»ºè¯·æ±‚æ—¶å¯ä»¥ç”¨çš„é€šç”¨é…ç½®é€‰é¡¹ã€‚åªæœ‰ url æ˜¯å¿…éœ€çš„ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®š methodï¼Œè¯·æ±‚å°†é»˜è®¤ä½¿ç”¨ GET æ–¹æ³•ã€‚

å®ä¾‹é…ç½®å’Œå•æ¬¡è¯·æ±‚é…ç½®å°†ä¼šåˆå¹¶ä¸ºæœ€ç»ˆè¯·æ±‚æ—¶çš„é…ç½®ï¼Œç›¸åŒçš„é€‰é¡¹ï¼Œåè€…ä¼šè¦†ç›–å‰è€…ã€‚

ç”±äºè¿è¡Œå°ç¨‹åºå¹³å°ä¸åŒï¼Œå¹³å°ç‰¹æœ‰çš„é…ç½®é€‰é¡¹è¿™é‡Œä¸å†åˆ—å‡ºã€‚ä½ å¯ä»¥æ·»åŠ ä»»ä½•è‡ªå®šä¹‰å­—æ®µï¼Œæœ€ç»ˆä¼šé€ä¼ ç»™å¯¹åº”çš„å°ç¨‹åºè¯·æ±‚ APIã€‚

```js
{
  // ç”¨äºè¯·æ±‚çš„æœåŠ¡å™¨ URLï¼Œä¼šå’Œ baseURL åˆå¹¶ä¸ºæœ€ç»ˆå‘é€çš„ url
  url: '/user',

  // åˆ›å»ºè¯·æ±‚æ—¶ä½¿ç”¨çš„æ–¹æ³•ï¼Œå¤§å°å†™å‡å¯
  method: 'get', // é»˜è®¤å€¼

  // baseURL å°†è‡ªåŠ¨åŠ åœ¨ url å‰é¢ï¼Œé™¤é url æ˜¯ä¸€ä¸ªç»å¯¹ URL
  baseURL: 'https://some-domain.com/api/',

  // è¯·æ±‚è½¬æ¢å™¨ï¼Œå…è®¸åœ¨å‘æœåŠ¡å™¨å‘é€è¯·æ±‚å‰ï¼Œä¿®æ”¹è¯·æ±‚æ•°æ®
  transformRequest: null,

  // å“åº”è½¬æ¢å™¨ï¼Œå…è®¸åœ¨æ¥æ”¶åˆ°å“åº”åï¼Œä¿®æ”¹å“åº”æ•°æ®
  transformResponse: null,

  // è¯·æ±‚å¤´
  headers: { 'X-Requested-With': 'XMLHttpRequest' },

  // æ˜¯å¦è·³è¿‡è¯·æ±‚é”
  skipLock: false,

  // å…è®¸è‡ªå®šä¹‰å“ªäº› HTTP çŠ¶æ€ç æ˜¯æœ‰æ•ˆçš„
  validateStatus: function (status) {
    return status >= 200 && status < 300; // é»˜è®¤å€¼
  },

  // å…è®¸è‡ªå®šä¹‰å¤„ç†è¯·æ±‚çš„é€‚é…å™¨ï¼Œæ¥æ”¶ config ä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ª promise å¹¶æä¾›ä¸€ä¸ªæœ‰æ•ˆçš„å“åº”
  adapter: function (config) {
    /* ... */
  },
}
```

## å“åº”ç»“æ„

ä¸€ä¸ªè¯·æ±‚çš„å“åº”åŒ…å«ä»¥ä¸‹é€šç”¨ä¿¡æ¯ï¼Œä»¥åŠå¯¹åº”å°ç¨‹åºå¹³å°è¿”å›çš„å“åº”ä¿¡æ¯ã€‚

```js
{
  // ç”±æœåŠ¡å™¨æä¾›çš„å“åº”æ•°æ®
  data: {},

  // æ¥è‡ªæœåŠ¡å™¨å“åº”çš„ HTTP çŠ¶æ€ç 
  status: 200,

  // æœåŠ¡å™¨çš„å“åº”å¤´
  headers: {},

  // è¯·æ±‚çš„é…ç½®ä¿¡æ¯
  config: {},
}
```

## æ ¡éªŒçŠ¶æ€ç 

åœ¨å¾®ä¿¡å°ç¨‹åºä¸­ï¼Œåªè¦æˆåŠŸæ”¶åˆ°æœåŠ¡å™¨è¿”å›ï¼Œæ— è®º HTTP çŠ¶æ€ç æ˜¯å¤šå°‘éƒ½ä¼šè¿›å…¥ success å›è°ƒã€‚è€Œåœ¨æ”¯ä»˜å®å°ç¨‹åºä¸­åˆ™è¿˜ä¼šæ ¡éªŒ HTTP çŠ¶æ€ç ï¼Œä¾‹å¦‚ 404ã€500ã€504 ç­‰çŠ¶æ€ç ä¼šè§¦å‘ fail å›è°ƒã€‚è¿™ä¸ªæ—¶å€™ä½ å¯ä»¥ä½¿ç”¨ `validateStatus` é…ç½®é€‰é¡¹è‡ªå®šä¹‰å“ªäº› HTTP çŠ¶æ€ç æ˜¯æœ‰æ•ˆçš„ï¼Œä»è€Œç»Ÿä¸€å¤šç«¯å°ç¨‹åºè¡Œä¸ºã€‚

```js
instance.get('/user/12345', {
  validateStatus: function (status) {
    return status >= 200 && status < 300; // è¿™æ˜¯é»˜è®¤é…ç½®
  },
});
```

## æ‹¦æˆªå™¨

ä½¿ç”¨æ‹¦æˆªå™¨åœ¨è¯·æ±‚å‘èµ·ä¹‹å‰å’Œæ”¶åˆ°å“åº”æ•°æ®ä¹‹åå¯¹é…ç½®æˆ–å“åº”åšä¸€äº›å¤„ç†ï¼Œå¹¶ä¸”å¯ä»¥åœ¨æ‹¦æˆªå™¨ä¸­æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ã€‚

```js
// æ·»åŠ è¯·æ±‚æ‹¦æˆªå™¨
instance.interceptors.request.use(
  function (config) {
    // åœ¨å‘é€è¯·æ±‚ä¹‹å‰åšäº›ä»€ä¹ˆï¼Œä¾‹å¦‚ä¿®æ”¹è¯·æ±‚çš„é…ç½®ã€è¯·æ±‚å¤´ã€URLï¼Œæ·»åŠ è®¤è¯ä¿¡æ¯ç­‰
    return config;
  },
  function (error) {
    // å¯¹è¯·æ±‚é”™è¯¯åšäº›ä»€ä¹ˆ
    return Promise.reject(error);
  },
);

// æ·»åŠ å“åº”æ‹¦æˆªå™¨
instance.interceptors.response.use(
  function (response) {
    // é»˜è®¤ 2xx èŒƒå›´å†…çš„ HTTP çŠ¶æ€ç éƒ½ä¼šè§¦å‘è¯¥å‡½æ•°ã€‚
    // å¯¹å“åº”æ•°æ®åšç‚¹ä»€ä¹ˆ
    return response;
  },
  function (error) {
    // é»˜è®¤ è¯·æ±‚å¤±è´¥æˆ–è¶…å‡º 2xx èŒƒå›´çš„ HTTP çŠ¶æ€ç éƒ½ä¼šè§¦å‘è¯¥å‡½æ•°ã€‚
    // å¯¹å“åº”é”™è¯¯åšç‚¹ä»€ä¹ˆï¼Œä¾‹å¦‚è®¾ç½®å…¨å±€é”™è¯¯å¤„ç†
    return Promise.reject(error);
  },
);
```

### å¤šä¸ªæ‹¦æˆªå™¨

å¦‚æœä½ æ·»åŠ äº†å¤šä¸ªè¯·æ±‚æˆ–å“åº”æ‹¦æˆªå™¨ï¼Œå®ƒä»¬ä¼šæŒ‰å¦‚ä¸‹é¡ºåºæ‰§è¡Œï¼š

1. å…ˆæ·»åŠ çš„è¯·æ±‚æ‹¦æˆªå™¨åæ‰§è¡Œï¼Œåæ·»åŠ çš„è¯·æ±‚æ‹¦æˆªå™¨å…ˆæ‰§è¡Œ
2. å…ˆæ·»åŠ çš„å“åº”æ‹¦æˆªå™¨å…ˆæ‰§è¡Œï¼Œåæ·»åŠ çš„å“åº”æ‹¦æˆªå™¨åæ‰§è¡Œ

## è½¬æ¢å™¨

`transformRequest` å…è®¸åœ¨å‘æœåŠ¡å™¨å‘é€è¯·æ±‚å‰ï¼Œä¿®æ”¹è¯·æ±‚æ•°æ®ã€‚å®ƒä¼šåœ¨è¯·æ±‚æ‹¦æˆªå™¨åæ‰§è¡Œã€‚

```js
{
  transformRequest: [function (data, headers) {
    // å¯¹å‘é€çš„ data è¿›è¡Œä»»æ„è½¬æ¢å¤„ç†ï¼Œæ³¨æ„æœ€åéœ€è¦ return data
    return data;
  }],
}
```

`transformResponse` å…è®¸åœ¨æ¥æ”¶åˆ°å“åº”åï¼Œä¿®æ”¹å“åº”æ•°æ®ã€‚å®ƒä¼šåœ¨å“åº”æ‹¦æˆªå™¨å‰æ‰§è¡Œã€‚

```js
{
  transformResponse: [function (data) {
    // å¯¹æ¥æ”¶çš„ data è¿›è¡Œä»»æ„è½¬æ¢å¤„ç†ï¼Œæ³¨æ„æœ€åéœ€è¦ return data
    return data;
  }],
}
```

### æ‹¦æˆªå™¨å’Œè½¬æ¢å™¨çš„åŒºåˆ«ï¼Ÿ

æ‹¦æˆªå™¨ä¸€èˆ¬ç”¨äºæ‹¦æˆªå’Œä¿®æ”¹è¯·æ±‚ä¸å“åº”çš„é…ç½®å’Œä¿¡æ¯ï¼Œå¯ä»¥å¤„ç†å¼‚æ­¥ä»»åŠ¡ã€‚è€Œè½¬æ¢å™¨ä¸€èˆ¬ç”¨äºå¯¹è¯·æ±‚ä¸å“åº”çš„æ•°æ®è¿›è¡Œæ ¼å¼è½¬æ¢ï¼Œåªèƒ½è¿›è¡ŒåŒæ­¥æ“ä½œã€‚

## è¯·æ±‚é”

å½“è¯·æ±‚é”å®šåï¼Œæ‰€æœ‰æœªå‘é€çš„è¯·æ±‚å°†ä¾æ¬¡ç­‰å¾…ï¼Œç›´åˆ°è¯·æ±‚è§£é”æ—¶æ‰èƒ½ç»§ç»­å‘é€ã€‚è¯·æ±‚é”æä¾›äº†å¦‚ä¸‹ APIï¼š

- `instance.lock()` å°†è¯·æ±‚é”å®š
- `instance.unlock()` å°†è¯·æ±‚è§£é”
- `instance.isLocked()` è¿”å›è¯·æ±‚æ˜¯å¦é”å®š
- `instance.release()` å°†é”å®šæœŸé—´å¾…å¤„ç†çš„è¯·æ±‚é‡Šæ”¾

åœ¨å‘é€è¯·æ±‚æ—¶ï¼Œé€šå¸¸ä¸ºäº†å®‰å…¨è€ƒè™‘ï¼Œä¼šå°†ç”¨äºæ ‡è¯†ç”¨æˆ·èº«ä»½çš„ token æ”¾åœ¨ headers ä¸­ã€‚å¦‚æœåœ¨æ­¤æ—¶å°šæœªè·å–åˆ° tokenï¼Œåˆ™ä¸€èˆ¬ä¼šåœ¨è·å–åˆ° token åå†å‘é€è¯·æ±‚ã€‚ç„¶è€Œï¼Œè‹¥å­˜åœ¨å¤šä¸ªè¯·æ±‚åŒæ—¶å¹¶å‘çš„æƒ…å†µï¼Œå¯èƒ½ä¼šå¯¼è‡´å¤šæ¬¡å‘é€è·å– token çš„è¯·æ±‚ã€‚

åœ¨è¿™ä¸ªåœºæ™¯æˆ‘ä»¬æœ‰ä¸¤ä¸ªè§£å†³åŠæ³•ï¼Œä¸€æ˜¯ä½¿ç”¨ç¼“å­˜ï¼Œè®©åŒæ—¶å‘é€è·å– token çš„è¯·æ±‚è¿”å›çš„éƒ½æ˜¯ä¸€ä¸ªè¯·æ±‚ã€‚äºŒæ˜¯ä½¿ç”¨è¯·æ±‚é”ï¼Œè·å–è·å– token æ—¶ï¼Œå°†å…¶ä½™è¯·æ±‚é”å®šï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```js
let token;

const getToken = () => {
  // ...
  // è·å– token çš„è¯·æ±‚é€»è¾‘
};

instance.interceptors.request.use(function (config) {
  if (!token) {
    // æ²¡æœ‰ token æ—¶å°†è¯·æ±‚é”å®š
    instance.lock();

    getToken()
      .then((token) => {
        config.headers.token = token;

        // è·å– token åå°†è¯·æ±‚è§£é”
        instance.unlock();
      })
      .catch(() => {
        // è·å– token å¤±è´¥åˆ™å¾…å¤„ç†çš„è¯·æ±‚å¤±æ•ˆï¼Œå¯ä»¥å…¨éƒ¨é‡Šæ”¾æ‰
        instance.release();
        instance.unlock();
      });
  } else {
    config.headers.token = token;
  }

  return config;
});
```
